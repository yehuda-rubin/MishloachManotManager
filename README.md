# Mishloach Manot Manager 🎁

מערכת לניהול הפצת משלוחי מנות קהילתיים. המערכת מאפשרת קליטת תושבים והזמנות מקבצי אקסל/CSV, ביצוע "שידוך" (Matching) חכם בין שולחים ומקבלים, והפקת דוחות חלוקה ותשלום.

## 📌 סטטוס פרויקט: פעיל (עם באגים ידועים)
המערכת עובדת ורצה, אך קיימת רגישות גבוהה לפורמט הקבצים ולסנכרון מזהים (IDs).

---

## 🚀 התקנה והרצה

### דרישות מוקדמות
- [Docker](https://www.docker.com/products/docker-desktop)
- [Docker Compose](https://docs.docker.com/compose/install/)

### הוראות הפעלה מהירה
1.  פתח מסוף (Terminal) בתיקיית הפרויקט.
2.  הרץ את הפקודה לבנייה והרמה של המערכת:
    ```bash
    docker-compose up --build
    ```
3.  פתח דפדפן בכתובת: **[http://localhost:5000](http://localhost:5000)**.

### איפוס המערכת (Clean Slate)
בכל פעם שמתחילים סבב טעינות חדש או אם נתקלים בשגיאות, מומלץ לאפס:
1.  לחץ על כפתור **"⚠️ איפוס נתונים"** האדום בתחתית דף הבית.
2.  האיפוס מוחק את כל התושבים וההזמנות ומחזיר את המערכת למצב התחלתי.

---

## 🛠️ תהליך העבודה (Workflow)

### 1. טעינת תושבים (Residents ETL)
* **דף:** `ניהול תושבים`
* **קובץ:** `CODES.xlsx` (או CSV).
* **פעולה:** המערכת קוראת את הקובץ, מנקה תווים נסתרים (BOM), מזהה עמודות באופן אוטומטי (`lastname`, `code`, `phone` וכו'), ושומרת את התושבים במסד הנתונים.
* **לוגיקה:** אם קיים קוד בקובץ – הוא נשמר כ-ID. אם לא – המערכת מייצרת ID אוטומטי.

### 2. טעינת הזמנות (Orders ETL)
* **דף:** `הזמנות חיצוניות` -> **טעינה**
* **קובץ:** `outer_orders.csv` (או אקסל).
* **פעולה:** טעינת רשימת ההזמנות לטבלת ביניים (`outerapporder`). המערכת מנסה לזהות את עמודת `sender_code`, `invitees`, ו-`phone`.

### 3. הפצה (Distribution)
* **דף:** `הזמנות חיצוניות` -> **הרץ הפצה**
* **לוגיקה:** המערכת רצה (בפייתון) על כל ההזמנות ומנסה למצוא את השולח:
    1.  לפי **קוד שולח** (Code).
    2.  אם נכשל – לפי **מספר טלפון** (Phone/Mobile) כמנגנון גיבוי.
    3.  אם נמצא השולח והמוזמנים – נוצרת רשומה בטבלת `Order`.

### 4. דוחות
* **דף:** `דוחות` (בתפריט)
* צפייה בסיכום חשבון, מאזן משפחות, וחלוקה לפי רחובות. ניתן לייצא ל-CSV.

---

## 🐛 באגים ידועים ובעיות פתוחות (TODO)

### 🔴 הבאג הקריטי: קפיצת מזהים וזיהוי כותרות
**תיאור:** לעיתים המערכת מזהה את שורת הכותרת כשורה של נתונים, או מתחילה למספר תושבים ממספרים גבוהים מאוד (למשל 12,000+), מה שגורם לחוסר התאמה מול קובץ ההזמנות שמצפה למספרים נמוכים (1-5000).
**סיבה משוערת:** שילוב בין הכנסה ידנית של מזהים (מהקובץ) לבין ה-Sequence האוטומטי של PostgreSQL, ורגישות לתווים נסתרים בכותרות.

### ✅ מה נעשה עד כה (Fixes Applied):
1.  **ניקוי BOM:** הוספת תמיכה בקידוד `utf-8-sig` להסרת תווים נסתרים בראש הקובץ.
2.  **מחיקת כפילויות:** מנגנון `loc[:,~df.columns.duplicated()]` למניעת עמודות כפולות.
3.  **איפוס מונה:** הוספת `setval` למונה האוטומטי לפני ואחרי כל טעינה כדי למנוע התנגשויות (`duplicate key`).
4.  **Fallback לכותרות:** אם לא נמצאה עמודת "code", המערכת מנסה לקחת את העמודה הראשונה כברירת מחדל.

### 📝 מה נשאר לעשות (To-Do List):
1.  **שיפור מנגנון זיהוי הכותרות:**
    * להוסיף לוגיקה שמתעלמת משורות ראשונות אם הן לא מכילות מילות מפתח ("קוד", "שם").
    * להוסיף ולידציה שמוודאת שערכי ה-`Code` הם באמת מספרים לפני השמירה (כדי לא לשמור את המילה "Code" כתושב).
2.  **בדיקת עומסים:** לוודא שהמערכת עומדת בקבצים של אלפי שורות בלי לקרוס (`TimeOut`).
3.  **ממשק ניהול שגיאות:** להציג למשתמש טבלה ברורה של "שורות שנכשלו" עם הסיבה המדויקת, ואפשרות לתיקון ידני.
4.  **טיפול בכתובות:** מנגנון איחוד רחובות (למשל "נחל שורק" ו-"שורק" יאוחדו לאותו רחוב).

---

## 💡 פתרון תקלות נפוצות

**שגיאה:** `duplicate key value violates unique constraint "person_pkey"`
* **פתרון:** לחץ על "איפוס מערכת" וטען מחדש. המונה יתאפס.

**שגיאה:** `The truth value of a Series is ambiguous`
* **פתרון:** יש לך שתי עמודות בקובץ שהמערכת מזהה כ-"Code". בדוק את שמות העמודות בקובץ האקסל.

**בעיה:** "ההפצה הסתיימה עם 0 הזמנות"
* **פתרון:** כנראה שהתושבים לא נקלטו עם הקודים הנכונים. בדוק בטבלת "לוג קליטה" איזה קודים קיבלו התושבים. אם הם קיבלו קודים ארוכים (מעל 10,000) וההזמנות הן קצרות – יש אי התאמה.
